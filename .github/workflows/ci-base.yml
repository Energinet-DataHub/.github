# Copyright 2020 Energinet DataHub A/S
#
# Licensed under the Apache License, Version 2.0 (the "License2");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: License and linting validation

# DESCRIPTION:
# This workflow is used to validate basic rules that is relevant for all
# repositories. A given repository might be able to skip certain rules but
# at least some of the rules are relevant for all repositories.

on:
  workflow_call:
    inputs:
      OPERATING_SYSTEM:
        required: false
        default: "ubuntu-22.04"
        type: string
      SKIP_MARKDOWN_CHECK:
        required: false
        type: string
        description: "Set to true to skip checking Markdown files."
        default: "false"
      SKIP_LICENSE_CHECK:
        required: false
        type: string
        description: "Set to true to skip checking License lines. All public repositories should run license check."
        default: "false"
      skip_yaml_lint:
        required: false
        type: string
        description: "Set to true to skip YAML linting for Github actions and workflows in repository."
        default: "true"
      skip_input_name_validation:
        required: false
        type: string
        description: "Set to true to skip input name validation for Github actions and workflows in repository."
        default: "true"

jobs:
  md_check:
    name: Markdown Check
    if: ${{ inputs.SKIP_MARKDOWN_CHECK != 'true' }}
    runs-on: ${{ inputs.OPERATING_SYSTEM }}
    env:
      REMOTE_REPO_PATH: ${{ github.workspace }}/remote
    steps:
      - name: Checkout local repo
        uses: actions/checkout@v3

      - name: Checkout remote repository
        uses: actions/checkout@v3
        with:
          repository: "Energinet-DataHub/.github"
          path: ${{ env.REMOTE_REPO_PATH }}

      - name: Copy configuration files
        run: |
          cp ${{ env.REMOTE_REPO_PATH }}/.github/utilities/md-check/.markdownlint.json ${{ github.workspace }}/.markdownlint.json
          cp ${{ env.REMOTE_REPO_PATH }}/.github/utilities/md-check/mlc_config.json ${{ github.workspace }}/mlc_config.json

      - name: Cleanup remote
        run: rm -rf ${{ env.REMOTE_REPO_PATH }}

      # https://github.com/marketplace/actions/markdown-link-check
      - name: Markdown links check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "yes"
          check-modified-files-only: "yes"
          config-file: "./mlc_config.json"
          base-branch: "main"
        continue-on-error: true
        id: md-link-check

      - name: Register markdownlint problem matcher
        uses: xt0rted/markdownlint-problem-matcher@v1
        id: md-lint-check-matcher

      # https://github.com/marketplace/actions/markdownlint-mdl-action
      - name: Markdown lint check
        uses: avto-dev/markdown-lint@v1
        with:
          args: "./"
        continue-on-error: true
        id: md-lint-check

      - name: Summarize
        run: |
          echo "Markdown check results: "
          fail=0
          if [[ "${{steps.md-link-check.conclusion}}" == "failure" ]] || [[ "${{steps.md-link-check.outcome}}" == "failure" ]]; then
            fail=1
            echo -e "- Markdown links check:   \e[31mFailure"
          else
            echo -e "- Markdown links check:   \e[32mSuccess"
          fi

          if [[ "${{steps.md-lint-check.conclusion}}" == "failure" ]] || [[ "${{steps.md-lint-check.outcome}}" == "failure" ]]; then
            fail=1
            echo -e "- Markdown lint check:    \e[31mFailure"
          else
            echo -e "- Markdown lint check:    \e[32mSuccess"
          fi
          if [[ $fail -eq 1 ]]; then
            echo -e "Expand individual steps above to view specific errors."
            exit 1
          fi

  check_license_lines:
    name: Check License Lines
    if: ${{ inputs.SKIP_LICENSE_CHECK != 'true' }}
    runs-on: ${{ inputs.OPERATING_SYSTEM }}
    env:
      REMOTE_REPO_PATH: ${{ github.workspace }}/remote
    steps:
      - name: Checkout local repo
        uses: actions/checkout@v3

      - name: Checkout remote repository
        uses: actions/checkout@v3
        with:
          repository: "Energinet-DataHub/.github"
          path: ${{ env.REMOTE_REPO_PATH }}

      - name: Copy configuration files
        run: cp ${{ env.REMOTE_REPO_PATH }}/.github/utilities/license-check/.licenserc.json ${{ github.workspace }}/.licenserc.json

      - name: Cleanup remote
        run: rm -rf ${{ env.REMOTE_REPO_PATH }}

      - name: Check License Lines
        shell: bash
        run: |
          yarn add @kt3k/license-checker@v3.2.2
          npx @kt3k/license-checker

  github_actions_yaml_linting:
    name: YAML linting for Github workflows and actions
    if: ${{ inputs.skip_yaml_lint != 'true' }}
    runs-on: ${{ inputs.OPERATING_SYSTEM }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run yamllint on .github/workflows folder
        uses: Energinet-DataHub/.github/.github/actions/yaml-lint@v10
        with:
          yaml_file_or_folder: .github/workflows

      - name: Run yamllint on  .github/actions folder
        uses: Energinet-DataHub/.github/.github/actions/yaml-lint@v10
        with:
          yaml_file_or_folder: .github/actions

  github_actions_input_name_validation:
    name: Input name validation for Github workflows and actions
    if: ${{ inputs.skip_input_name_validation != 'true' }}
    runs-on: ${{ inputs.OPERATING_SYSTEM }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # TODO: Remove when done testing
      - name: Test use of outputs
        uses: Energinet-DataHub/.github/.github/actions/nuget-get-version-suffix@dstenroejl/enhance-input-validation
        id: get_version_suffix

      # TODO: Remove when done testing
      - name: Print output value
        shell: pwsh
        run: |
          Write-Host "Output: '${{ steps.get_version_suffix.outputs.version_suffix_property }}'"

      - name: Validate input fields in .github/workflows folder
        uses: Energinet-DataHub/.github/.github/actions/github-actions-input-name-validate@dstenroejl/enhance-input-validation # TODO: Set to v10 before merge
        with:
          yaml_file_or_folder: .github/workflows

      - name: Validate input fields in .github/actions folder
        uses: Energinet-DataHub/.github/.github/actions/github-actions-input-name-validate@dstenroejl/enhance-input-validation # TODO: Set to v10 before merge
        with:
          yaml_file_or_folder: .github/actions
