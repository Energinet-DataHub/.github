name: "Python Covernator Commit"
description: "Generate and commit Covernator coverage results, with change detection and commit guard"

inputs:
  project_directory:
    required: true
    description: "Path to the project root (where tests/ live)"
  geh_common_version:
    required: false
    default: "7.2.2"
    description: "geh_common package version"

runs:
  using: "composite"
  steps:
    # -------------------------------------------------------------------------
    # 1Ô∏è‚É£ Checkout domain repository (no persisted credentials)
    # -------------------------------------------------------------------------
    - name: Checkout domain repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: false

    # -------------------------------------------------------------------------
    # 2Ô∏è‚É£ Detect relevant file changes
    # -------------------------------------------------------------------------
    - name: Detect relevant file changes for Covernator
      id: covernator_changed
      uses: tj-actions/changed-files@v46
      with:
        since_last_remote_commit: true
        files: |
          source/geh_wholesale/tests/**/*.yml
          source/geh_wholesale/tests/**/test_*.py

    - name: Print change detection summary
      shell: bash
      run: |
        echo "Covernator change detection:"
        echo "Any changed: ${{ steps.covernator_changed.outputs.any_changed }}"
        echo "Changed files:"
        echo "${{ steps.covernator_changed.outputs.all_changed_files }}"

    # -------------------------------------------------------------------------
    # 3Ô∏è‚É£ Setup Python + UV
    # -------------------------------------------------------------------------
    - name: Setup Python
      if: steps.covernator_changed.outputs.any_changed == 'true'
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Setup uv
      if: steps.covernator_changed.outputs.any_changed == 'true'
      uses: astral-sh/setup-uv@v5

    # -------------------------------------------------------------------------
    # 4Ô∏è‚É£ Install geh_common
    # -------------------------------------------------------------------------
    - name: Install geh_common
      if: steps.covernator_changed.outputs.any_changed == 'true'
      shell: bash
      run: |
        echo "Installing geh_common from branch ${{ inputs.geh_common_version }}"
        uv pip install --system \
          "geh_common @ git+https://git@github.com/Energinet-DataHub/opengeh-python-packages@${{ inputs.geh_common_version }}#subdirectory=source/geh_common"

    # -------------------------------------------------------------------------
    # 5Ô∏è‚É£ Run Covernator analysis and markdown generation
    # -------------------------------------------------------------------------
    - name: Run Covernator + Markdown generator
      if: steps.covernator_changed.outputs.any_changed == 'true'
      shell: bash
      run: |
        python - <<'PYCODE'
        import os
        from geh_common.testing.covernator.entrypoints import run_and_generate_markdown

        project_dir = os.getenv("PROJECT_DIRECTORY")
        if not project_dir:
            raise ValueError("Missing PROJECT_DIRECTORY input for Covernator action.")
        print(f"üîç Running Covernator analysis on: {project_dir}")
        run_and_generate_markdown(project_dir)
        PYCODE
      env:
        PROJECT_DIRECTORY: ${{ inputs.project_directory }}

    # -------------------------------------------------------------------------
    # 6Ô∏è‚É£ Commit markdown only when differences exist (Fix 1)
    # -------------------------------------------------------------------------
    - name: Commit and push markdown to docs
      if: steps.covernator_changed.outputs.any_changed == 'true'
      shell: bash
      env:
        BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      run: |
        set -e
        echo "üì¶ Checking for local differences before commit."
        echo "üßæ Files in docs/covernator/:"
        ls -la docs/covernator/ || echo "(folder missing)"

        git config user.name "github-actions"
        git config user.email "ci@github.com"

        # Handle missing file (first commit case)
        if [ ! -f docs/covernator/coverage_overview.md ]; then
          echo "üÜï coverage_overview.md not found ‚Äî committing new file."
          git add -f docs/covernator/coverage_overview.md || true
          git commit -m "üß© Add initial Covernator results [skip ci]" || exit 0
          echo "‚úÖ Initial file committed."
          exit 0
        fi

        # Detect diffs and skip push completely if none
        if git diff --quiet docs/covernator/coverage_overview.md; then
          echo "‚úÖ No differences detected ‚Äî skipping commit and push."
          exit 0    # <-- Fix 1: exit before any push
        fi

        echo "üß© Differences detected ‚Äî committing results."
        git add -f docs/covernator/coverage_overview.md
        git commit -m "üß© Update Covernator results [skip ci]"
        # Authenticate manually using default token only when needed
        git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
        git push origin HEAD:${BRANCH_NAME}
        echo "‚úÖ Results committed successfully."
