name: Python Covernator Commit
description: Generate and commit Covernator coverage results, with change detection and commit guard

inputs:
  project_directory:
    required: true
    description: Path to the project root (where tests/ live)
  geh_common_version:
    required: true
    description: geh_common package version
  github_token:
    required: true
    description: Github token used to checkout the repository and commit changes

runs:
  using: composite
  steps:
    # -------------------------------------------------------------------------
    # 1Ô∏è‚É£ Checkout repository
    # -------------------------------------------------------------------------
    - name: Checkout domain repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true
        token: ${{ inputs.github_token }}

    # -------------------------------------------------------------------------
    # 2Ô∏è‚É£ Setup Python + UV
    # -------------------------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        # Instead of hardcoding an exact version, use the runner default major version
        python-version: 3.x

    - name: Setup uv
      uses: astral-sh/setup-uv@v5

    # -------------------------------------------------------------------------
    # 3Ô∏è‚É£ Install geh_common
    # -------------------------------------------------------------------------
    - name: Install geh_common
      shell: bash
      run: |
        echo "Installing geh_common from branch ${{ inputs.geh_common_version }}"
        uv pip install --system \
          "geh_common @ git+https://git@github.com/Energinet-DataHub/opengeh-python-packages@geh_common_${{ inputs.geh_common_version }}#subdirectory=source/geh_common"

    # -------------------------------------------------------------------------
    # 4Ô∏è‚É£ Run Covernator analysis and markdown generation
    # -------------------------------------------------------------------------
    - name: Run Covernator + Markdown generator
      shell: bash
      run: |
        python - <<'PYCODE'
        import os
        from geh_common.testing.covernator.entrypoints import run_and_generate_markdown

        project_dir = os.getenv("PROJECT_DIRECTORY")
        if not project_dir:
          raise ValueError("Missing PROJECT_DIRECTORY input for Covernator action.")

        print(f"üîç Running Covernator analysis on: {project_dir}")
        run_and_generate_markdown(project_dir)
        PYCODE
      env:
        PROJECT_DIRECTORY: ${{ inputs.project_directory }}

    # -------------------------------------------------------------------------
    # 5Ô∏è‚É£ Commit only if markdown truly changed (Layer 2 logic)
    # -------------------------------------------------------------------------
    - name: Configure author
      shell: bash
      run: |
        git status
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit updated coverage_overview.md
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: Updated Covernator results
        file_pattern: docs/covernator/coverage_overview.md
